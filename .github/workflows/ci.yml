name: CI

on:
  push:
    branches:
      - main
      - dev
      - stg
  workflow_dispatch:
    inputs:
      buildType:
        description: 'Build type (all, affected, or project names)'
        required: false
        default: 'affected'

permissions:
  actions: read
  contents: read

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    # Automatically use the GitHub environment based on the branch name
    environment: ${{ github.ref_name }}

    steps:
      # Checkout the repository
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set up Node.js environment
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # Set commit SHAs for Nx
      - uses: nrwl/nx-set-shas@v4

      # Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Authenticate to Google Container Registry
        run: gcloud auth configure-docker

      # Install dependencies
      - run: npm ci --legacy-peer-deps

      # Lint, test, and build affected applications
      # - run: npx nx affected -t lint test build
      - run: npx nx run-many -t build -p frontend backend
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL }}

      - name: Build, Push, and Deploy Docker Images
        run: |
          declare -A ENV_VARS
          ENV_VARS[frontend]="API_BASE_URL=${{ secrets.API_BASE_URL }}"

          ENV_VARS[backend]="MONGOOS_URL=${{ secrets.MONGOOS_URL }} \
          JWT_SECRET=${{ secrets.JWT_SECRET }} \
          FORGOT_PASSWORD_JWT_SECRET=${{ secrets.FORGOT_PASSWORD_JWT_SECRET }} \
          REFRESH_TOKEN_JWT_SECRET=${{ secrets.REFRESH_TOKEN_JWT_SECRET }} \
          FRONTEND_BASE_URL=${{ secrets.FRONTEND_BASE_URL }} \
          SMTP_HOST=${{ secrets.SMTP_HOST }} \
          SMTP_PORT=${{ secrets.SMTP_PORT }} \
          SMTP_USER=${{ secrets.SMTP_USER }} \
          SMTP_PASS=${{ secrets.SMTP_PASS }}"

          for app in frontend backend; do
            app_name="${{ secrets.APP_NAME }}-${{ github.ref_name }}-$app"
            image="gcr.io/${{ secrets.PROJECT_ID }}/${app_name}:latest"
            service_name="$app_name-service"
            
            echo "Building Docker image for $app..."
            docker build -t $image --build-arg APP=$app -f apps/$app/Dockerfile .
            docker push $image

            echo "Deploying $app to Cloud Run..."
            gcloud run deploy $service_name --image $image --region=${{ secrets.REGION }} --quiet --set-env-vars="${ENV_VARS[$app]}"
          done
